<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Performance and string data - polars-book</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction/introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../getting_started.html"><strong aria-hidden="true">2.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="../#.html"><strong aria-hidden="true">3.</strong> IO</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../io/files.html"><strong aria-hidden="true">3.1.</strong> File IO</a></li><li class="chapter-item "><a href="../io/aws.html"><strong aria-hidden="true">3.2.</strong> aws</a></li></ol></li><li class="chapter-item expanded "><a href="../lazy_polars/intro.html"><strong aria-hidden="true">4.</strong> Lazy Polars</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../lazy_polars/predicate_pushdown.html"><strong aria-hidden="true">4.1.</strong> Predicate pushdown</a></li><li class="chapter-item "><a href="../lazy_polars/projection_pushdown.html"><strong aria-hidden="true">4.2.</strong> Projection pushdown</a></li><li class="chapter-item "><a href="../lazy_polars/other_optimizations.html"><strong aria-hidden="true">4.3.</strong> Other optimizations</a></li></ol></li><li class="chapter-item expanded "><a href="../how_can_i/intro.html"><strong aria-hidden="true">5.</strong> How can I?</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../how_can_i/groupby.html"><strong aria-hidden="true">5.1.</strong> GroupBy</a></li><li class="chapter-item "><a href="../how_can_i/aggregate.html"><strong aria-hidden="true">5.2.</strong> Aggregate</a></li><li class="chapter-item "><a href="../how_can_i/conditionally_apply.html"><strong aria-hidden="true">5.3.</strong> Conditionally apply</a></li><li class="chapter-item "><a href="../how_can_i/parse_dates.html"><strong aria-hidden="true">5.4.</strong> Parse dates</a></li><li class="chapter-item "><a href="../how_can_i/use_custom_functions.html"><strong aria-hidden="true">5.5.</strong> Use custom functions</a></li><li class="chapter-item "><a href="../how_can_i/process_strings.html"><strong aria-hidden="true">5.6.</strong> Process strings</a></li><li class="chapter-item "><a href="../how_can_i/apply_window_functions.html"><strong aria-hidden="true">5.7.</strong> Apply window functions</a></li><li class="chapter-item "><a href="../how_can_i/split_apply_combine.html"><strong aria-hidden="true">5.8.</strong> Split/ apply / combine</a></li></ol></li><li class="chapter-item expanded "><a href="../numpy.html"><strong aria-hidden="true">6.</strong> Numpy interop</a></li><li class="chapter-item expanded "><a href="../reference.html"><strong aria-hidden="true">7.</strong> Reference guide</a></li><li class="chapter-item expanded "><a href="../performance/intro.html"><strong aria-hidden="true">8.</strong> Performance</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../performance/string_data.html" class="active"><strong aria-hidden="true">8.1.</strong> Performance and string data</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">polars-book</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="performance-and-string-data"><a class="header" href="#performance-and-string-data">Performance and string data</a></h2>
<p>Understanding the memory format used by Arrow/ Polars can really increase performance of your
queries. This is especially true for large string data. The figure below shows how an Arrow UTF8
array is laid out in memory.</p>
<p>The array <code>[&quot;foo&quot;, &quot;bar&quot;, &quot;ham&quot;]</code> is encoded by </p>
<ul>
<li>a concatenated string <code>&quot;foobarham&quot;</code></li>
<li>an offset array indicating the start (and end) of each string <code>[0, 2, 5, 8]</code></li>
<li>a null bitmap, indicating null values</li>
</ul>
<p><img src="https://raw.githubusercontent.com/ritchie46/img/master/polars/arrow/arrow_string.svg" alt="" /></p>
<p>This memory structure is very cache efficient if we are to read the string values. Especially if
we compare it to a <code>Vec&lt;String&gt;</code> (an array of heap allocated string data in Rust).</p>
<p><img src="https://raw.githubusercontent.com/ritchie46/img/master/polars/arrow/pandas_string.svg" alt="" /></p>
<p>However, if we need to reorder the Arrow UTF8 array, we need to swap around all the bytes of the
string values, which can become very expensive when we're dealing with large strings. On the
other hand, for the <code>Vec&lt;String&gt;</code>, we only need to swap pointers around which is only 8 bytes data
that have to be moved.</p>
<p>If you have a <code>DataFrame</code> with a large number of
Utf8 <code>Series</code> and you need to reorder them due to an
operation like a FILTER, JOIN, GROUPBY, etc. than this can become quite expensive.</p>
<h2 id="categorical-type"><a class="header" href="#categorical-type">Categorical type</a></h2>
<p>For this reason Polars has a <code>CategoricalType</code>. A Categorical
<code>Series</code> is an array filled with <code>u32</code> values that each represent a unique string value.
Thereby maintaining cache-efficiency, whilst also making it cheap to move values around.</p>
<h3 id="example-single-dataframe"><a class="header" href="#example-single-dataframe">Example: Single DataFrame</a></h3>
<p>In the example below we show how you can cast an Utf8 <code>Series</code> column to a Categorical <code>Series</code>.</p>
<pre><code class="language-python">import polars as pl

df[&quot;utf8-column&quot;].cast(pl.Categorical)
</code></pre>
<h3 id="example-eager-join-multiple-dataframes-on-a-categorical"><a class="header" href="#example-eager-join-multiple-dataframes-on-a-categorical">Example: Eager join multiple DataFrames on a Categorical</a></h3>
<p>When the strings of one column need to be joined with the string data from another <code>DataFrame</code>.
The <code>Categorical</code> data needs to be synchronized (Categories in <code>df A</code> need to point to the same
underlying string data as Categories in <code>df B</code>). You can do by casting data int he <code>StringCache</code> context manager. 
This will synchronize all seen string values for the duration of that context manager. If you want the global string cache
to be existent during the whole program run, you can set <code>toggle_string_cache</code> to <code>True</code></p>
<pre><code class="language-python">import polars as pl

df_a = pl.DataFrame({&quot;a&quot;: [&quot;foo&quot;, &quot;bar&quot;, &quot;ham&quot;], &quot;b&quot;: [1, 2, 3]})
df_b = pl.DataFrame({&quot;a&quot;: [&quot;foo&quot;, &quot;spam&quot;, &quot;eggs&quot;], &quot;c&quot;: [3, 2, 2]})

with pl.StringCache():
    df_a[&quot;a&quot;] = df_a[&quot;a&quot;].cast(pl.Categorical)
    df_b[&quot;a&quot;] = df_b[&quot;a&quot;].cast(pl.Categorical)


</code></pre>
<h3 id="example-lazy-join-multiple-dataframes-on-a-categorical"><a class="header" href="#example-lazy-join-multiple-dataframes-on-a-categorical">Example: Lazy join multiple DataFrames on a Categorical</a></h3>
<p>A lazy Query always has a global string cache (unless you opt-out) for the duration of that query (until <code>collect</code> is called).
The example below shows how you could join two DataFrames with Categorical types.</p>
<pre><code class="language-python">df_a = pl.DataFrame({&quot;a&quot;: [&quot;foo&quot;, &quot;bar&quot;, &quot;ham&quot;], &quot;b&quot;: [1, 2, 3]}).lazy()
df_b = pl.DataFrame({&quot;a&quot;: [&quot;foo&quot;, &quot;spam&quot;, &quot;eggs&quot;], &quot;c&quot;: [3, 2, 2]}).lazy()

df_a = df_a.with_column(pl.col(&quot;a&quot;).cast(pl.Categorical))
df_b = df_b.with_column(pl.col(&quot;a&quot;).cast(pl.Categorical))

df_a.join(df_b, on=&quot;a&quot;, how=&quot;inner&quot;)
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../performance/intro.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../performance/intro.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
